module da_vert_coord_mod

    use flogger
    use namelist_mod

    implicit none

    private

    public da_vert_coord_init
    public da_vert_coord_final
    public da_vert_coord_calc_ph_lev

    real(8), allocatable, dimension(:) :: sigi
    real(8), allocatable, dimension(:) :: hyai
    real(8), allocatable, dimension(:) :: hybi
    real(8) :: p0
    real(8) :: pt = 1d5 ! Model top pressure (Pa)
    real(8) :: local_ptop

    interface
        pure real(8) function da_vert_coord_calc_ph_lev_interface(k, phs)
            integer, intent(in) :: k
            real(8), intent(in) :: phs
        end function da_vert_coord_calc_ph_lev_interface
    end interface

    procedure(da_vert_coord_calc_ph_lev_interface), pointer :: da_vert_coord_calc_ph_lev

contains

    subroutine da_vert_coord_init(num_lev, scheme, template)

        integer, intent(in) :: num_lev
        character(*), intent(in), optional :: scheme
        character(*), intent(in), optional :: template

        select case (scheme)
        case ('sigma')
          !call sigma_coord_init(num_lev, namelist_file, vert_coord_template)
          da_vert_coord_calc_ph_lev => da_sigma_coord_calc_ph_lev
        case ('hybrid')
          !call hybrid_coord_init(num_lev, namelist_file, vert_coord_template)
          da_vert_coord_calc_ph_lev => da_hybrid_coord_calc_ph_lev
        end select

        allocate(sigi(num_lev+1)); sigi = 0

        sigi = [                                                             &
        0.0, 0.00270708138944839, 0.00770525729190707, 0.0158928127640089, &
        0.0277039568735249, 0.0425225717851423, 0.0595424438370873,        &
        0.0764861789945283, 0.09037000846462, 0.106703636692459,           &
        0.125919292600401, 0.148525517478954, 0.175120586853872,           &
        0.206408247111974, 0.243216666654805, 0.286519798881535,           &
        0.33746367336785, 0.397396487729323, 0.467904355709719,            &
        0.550853249115629, 0.648438367513145, 0.743820793246579,           &
        0.830649646952043, 0.903087677425118, 0.955900674543326,           &
        0.985079453568069, 1.0                                             &
        ]

        pt = 219.406699761748

        allocate(hyai(num_lev+1)); hyai = 0
        allocate(hybi(num_lev+1)); hybi = 0

        select case (template)
        case ('test_l15')
            hyai = [0.20540233  , & !  1
                    0.19853043  , & !  2
                    0.19095544  , & !  3
                    0.18262359  , & !  4
                    0.17347834  , & !  5
                    0.16346029  , & !  6
                    0.15250707  , & !  7
                    0.14055334  , & !  8
                    0.12753061  , & !  9
                    0.11336724  , & !  10
                    0.09798832  , & !  11
                    0.08131559  , & !  12
                    0.06326738  , & !  13
                    0.04375850  , & !  14
                    0.02270019  , & !  15
                    0.00000000]     !  16
            hybi = [0.00000     , & !  1
                    0.03345579  , & !  2
                    0.07033459  , & !  3
                    0.11089815  , & !  4
                    0.15542174  , & !  5
                    0.20419459  , & !  6
                    0.25752023  , & !  7
                    0.31571693  , & !  8
                    0.37911800  , & !  9
                    0.44807228  , & !  10
                    0.52294448  , & !  11
                    0.60411556  , & !  12
                    0.69198316  , & !  13
                    0.78696201  , & !  14
                    0.88948427  , & !  15
                    1.00000000]     !  16
            p0 = 1d5 ! Pa
            ptop = p0 * hyai(1)
        case ('test_l26')
            hyai = [0.002194067  , & !  1
                    0.004895209  , & !  2
                    0.009882418  , & !  3
                    0.01805201   , & !  4
                    0.02983724   , & !  5
                    0.04462334   , & !  6
                    0.06160587   , & !  7
                    0.07851243   , & !  8
                    0.07731271   , & !  9
                    0.07590131   , & ! 10
                    0.07424086   , & ! 11
                    0.07228744   , & ! 12
                    0.06998933   , & ! 13
                    0.06728574   , & ! 14
                    0.06410509   , & ! 15
                    0.06036322   , & ! 16
                    0.05596111   , & ! 17
                    0.05078225   , & ! 18
                    0.04468960   , & ! 19
                    0.03752191   , & ! 20
                    0.02908949   , & ! 21
                    0.02084739   , & ! 22
                    0.01334443   , & ! 23
                    0.00708499   , & ! 24
                    0.00252136   , & ! 25
                    0.00000000   , & ! 26
                    0.00000000]      ! 27
            hybi = [0.000000     , & !  1
                    0.000000     , & !  2
                    0.000000     , & !  3
                    0.000000     , & !  4
                    0.000000     , & !  5
                    0.000000     , & !  6
                    0.000000     , & !  7
                    0.000000     , & !  8
                    0.01505309   , & !  9
                    0.03276228   , & ! 10
                    0.05359622   , & ! 11
                    0.07810627   , & ! 12
                    0.1069411    , & ! 13
                    0.1408637    , & ! 14
                    0.1807720    , & ! 15
                    0.2277220    , & ! 16
                    0.2829562    , & ! 17
                    0.3479364    , & ! 18
                    0.4243822    , & ! 19
                    0.5143168    , & ! 20
                    0.6201202    , & ! 21
                    0.7235355    , & ! 22
                    0.8176768    , & ! 23
                    0.8962153    , & ! 24
                    0.9534761    , & ! 25
                    0.9851122    , & ! 26
                    1.0000000]       ! 27
            p0 = 1d5 ! Pa
            ptop = p0 * hyai(1)
        case ('test_l30')
            hyai = [0.20540233  , & !  1
                    0.20205101  , & !  2
                    0.19853043  , & !  3
                    0.19483412  , & !  4
                    0.19095544  , & !  5
                    0.18688759  , & !  6
                    0.18262359  , & !  7
                    0.17815629  , & !  8
                    0.17347834  , & !  9
                    0.16858224  , & !  10
                    0.16346029  , & !  11
                    0.15810459  , & !  12
                    0.15250707  , & !  13
                    0.14665948  , & !  14
                    0.14055334  , & !  15
                    0.13418     , & !  16
                    0.12753061  , & !  17
                    0.12059611  , & !  18
                    0.11336724  , & !  19
                    0.10583453  , & !  20
                    0.09798832  , & !  21
                    0.0898187   , & !  22
                    0.08131559  , & !  23
                    0.07246866  , & !  24
                    0.06326738  , & !  25
                    0.05370098  , & !  26
                    0.0437585   , & !  27
                    0.03342871  , & !  28
                    0.02270019  , & !  29
                    0.01156125  , & !  30
                    0.00000000]     !  31

            hybi = [0.00000     , & !  1
                    0.01631585  , & !  2
                    0.03345579  , & !  3
                    0.05145127  , & !  4
                    0.07033459  , & !  5
                    0.09013889  , & !  6
                    0.11089815  , & !  7
                    0.13264719  , & !  8
                    0.15542174  , & !  9
                    0.17925837  , & !  10
                    0.20419459  , & !  11
                    0.23026877  , & !  12
                    0.25752023  , & !  13
                    0.28598922  , & !  14
                    0.31571693  , & !  15
                    0.34674548  , & !  16
                    0.37911800  , & !  17
                    0.41287857  , & !  18
                    0.44807228  , & !  19
                    0.48474521  , & !  20
                    0.52294448  , & !  21
                    0.56271820  , & !  22
                    0.60411556  , & !  23
                    0.64718678  , & !  24
                    0.69198316  , & !  25
                    0.73855571  , & !  26
                    0.78696201  , & !  27
                    0.83725251  , & !  28
                    0.88948427  , & !  29
                    0.94371412  , & !  30
                    1.00000000]     !  31

            p0 = 1d5 ! Pa
            ptop = p0 * hyai(1)
        case ('wrf_l16')
            hyai = [          &
                    0.00000000e+00, &
                    6.25000000e-02, &
                    1.25000000e-01, &
                    1.87500000e-01, &
                    2.41699219e-01, &
                    2.72331238e-01, &
                    2.82287598e-01, &
                    2.75001526e-01, &
                    2.53906250e-01, &
                    2.22434998e-01, &
                    1.84020996e-01, &
                    1.42097473e-01, &
                    1.00097656e-01, &
                    6.14547729e-02, &
                    2.96020508e-02, &
                    7.97271729e-03, &
                    4.44089210e-16  &
                    ]
                    hybi = [          &
                    0.00000000e+00, &
                    0.00000000e+00, &
                    0.00000000e+00, &
                    0.00000000e+00, &
                    8.30078125e-03, &
                    4.01687622e-02, &
                    9.27124023e-02, &
                    1.62498474e-01, &
                    2.46093750e-01, &
                    3.40065002e-01, &
                    4.40979004e-01, &
                    5.45402527e-01, &
                    6.49902344e-01, &
                    7.51045227e-01, &
                    8.45397949e-01, &
                    9.29527283e-01, &
                    1.00000000e+00  &
                    ]

            p0 = 1d5       ! Pa
            local_ptop = ptop
        case ('wrf_l26')
            hyai = [              &
                0.0000000000000000, & !  1
                0.0026949368990385, & !  2
                0.0076765830700214, & !  3
                0.0158441481359590, & !  4
                0.0276273570916710, & !  5
                0.0414422617493396, & !  6
                0.0562280278845174, & !  7
                0.0724791367109593, & !  8
                0.0893764691932271, & !  9
                0.1063516039069875, & ! 10
                0.1254699736141626, & ! 11
                0.1479612378540120, & ! 12
                0.1744206867899481, & ! 13
                0.2054467443488705, & ! 14
                0.2362331354387115, & ! 15
                0.2617244861517879, & ! 16
                0.2783056303113054, & ! 17
                0.2816242061994436, & ! 18
                0.2669746497908253, & ! 19
                0.2303286706439434, & ! 20
                0.1705682721867309, & ! 21
                0.1064887571082237, & ! 22
                0.0535041093004280, & ! 23
                0.0199854375869117, & ! 24
                0.0049141727575007, & ! 25
                0.0008271366689887, & ! 26
                0.0000000000000000  & ! 27
                ]
                hybi = [              &
                0.0000000000000000, & !  1
                0.0000000000000000, & !  2
                0.0000000000000000, & !  3
                0.0000000000000000, & !  4
                0.0000000000000000, & !  5
                0.0000000000000000, & !  6
                0.0000000000000000, & !  7
                0.0000000000000000, & !  8
                0.0000000000000000, & !  9
                0.0000000000000000, & ! 10
                0.0000000000000000, & ! 11
                0.0000000000000000, & ! 12
                0.0000000000000000, & ! 13
                0.0001055707738109, & ! 14
                0.0059372955912098, & ! 15
                0.0235354910761884, & ! 16
                0.0576432893794934, & ! 17
                0.1139595353789115, & ! 18
                0.1987640251563301, & ! 19
                0.3179517452840197, & ! 20
                0.4748134785123594, & ! 21
                0.6338019812807031, & ! 22
                0.7731855115963033, & ! 23
                0.8787837382816079, & ! 24
                0.9464020881646360, & ! 25
                0.9795195430185113, & ! 26
                1.0000000000000000  & ! 27
                ]

                p0 = 1d5 ! Pa
                local_ptop = ptop
        case ('wrf_l32')
            hyai = [              &
                0.0000000000000000, & !  1
                0.0027008056640625, & !  2
                0.0076868347823620, & !  3
                0.0158526937798342, & !  4
                0.0276367470939261, & !  5
                0.0414515552099706, & !  6
                0.0562277844155789, & !  7
                0.0724737972365225, & !  8
                0.0893795253309864, & !  9
                0.1063548465048298, & ! 10
                0.1254725257849640, & ! 11
                0.1479642011314251, & ! 12
                0.1744233770857367, & ! 13
                0.2054476619883455, & ! 14
                0.2362396334209435, & ! 15
                0.2617261684535087, & ! 16
                0.2783057827853432, & ! 17
                0.2816243248017372, & ! 18
                0.2683280168286641, & ! 19
                0.2429473354807992, & ! 20
                0.2108099294331058, & ! 21
                0.1759998110016148, & ! 22
                0.1415334037742616, & ! 23
                0.1095123294032484, & ! 24
                0.0812761592574764, & ! 25
                0.0575423961814687, & ! 26
                0.0385285881906738, & ! 27
                0.0240694984015316, & ! 28
                0.0137226170696702, & ! 29
                0.0068720184783044, & ! 30
                0.0027973066609278, & ! 31
                0.0007580797514921, & ! 32
                0.0000000000000000  & ! 33
                ]
                hybi = [              &
                0.0000000000000000, & !  1
                0.0000000000000000, & !  2
                0.0000000000000000, & !  3
                0.0000000000000000, & !  4
                0.0000000000000000, & !  5
                0.0000000000000000, & !  6
                0.0000000000000000, & !  7
                0.0000000000000000, & !  8
                0.0000000000000000, & !  9
                0.0000000000000000, & ! 10
                0.0000000000000000, & ! 11
                0.0000000000000000, & ! 12
                0.0000000000000000, & ! 13
                0.0001056069805219, & ! 14
                0.0059397906834944, & ! 15
                0.0235374270991938, & ! 16
                0.0576439176162314, & ! 17
                0.1139578493851603, & ! 18
                0.1932313936022966, & ! 19
                0.2808764820852269, & ! 20
                0.3715629284436812, & ! 21
                0.4612091687348547, & ! 22
                0.5467954414732804, & ! 23
                0.6262219272258057, & ! 24
                0.6981497395977654, & ! 25
                0.7618575996945027, & ! 26
                0.8171268253424389, & ! 27
                0.8641240158900223, & ! 28
                0.9032994538662682, & ! 29
                0.9352560448161740, & ! 30
                0.9607227915792738, & ! 31
                0.9804356127137464, & ! 32
                1.0000000000000000  & ! 33
                ]
            p0 = 1d5       ! Pa
            local_ptop = ptop
        case ('wrf_l64')
            hyai = [          &
                0.00000000e+00, & !  1
                1.56250000e-02, & !  2
                3.12500000e-02, & !  3
                4.68750000e-02, & !  4
                6.25000000e-02, & !  5
                7.81250000e-02, & !  6
                9.37500000e-02, & !  7
                1.09375000e-01, & !  8
                1.25000000e-01, & !  9
                1.40625000e-01, & !  10
                1.56250000e-01, & !  11
                1.71875000e-01, & !  12
                1.87500000e-01, & !  13
                2.03091502e-01, & !  14
                2.17556953e-01, & !  15
                2.30408311e-01, & !  16
                2.41699219e-01, & !  17
                2.51483321e-01, & !  18
                2.59814262e-01, & !  19
                2.66745687e-01, & !  20
                2.72331238e-01, & !  21
                2.76624560e-01, & !  22
                2.79679298e-01, & !  23
                2.81549096e-01, & !  24
                2.82287598e-01, & !  25
                2.81948447e-01, & !  26
                2.80585289e-01, & !  27
                2.78251767e-01, & !  28
                2.75001526e-01, & !  29
                2.70888209e-01, & !  30
                2.65965462e-01, & !  31
                2.60286927e-01, & !  32
                2.53906250e-01, & !  33
                2.46877074e-01, & !  34
                2.39253044e-01, & !  35
                2.31087804e-01, & !  36
                2.22434998e-01, & !  37
                2.13348269e-01, & !  38
                2.03881264e-01, & !  39
                1.94087625e-01, & !  40
                1.84020996e-01, & !  41
                1.73735023e-01, & !  42
                1.63283348e-01, & !  43
                1.52719617e-01, & !  44
                1.42097473e-01, & !  45
                1.31470561e-01, & !  46
                1.20892525e-01, & !  47
                1.10417008e-01, & !  48
                1.00097656e-01, & !  49
                8.99881124e-02, & !  50
                8.01420212e-02, & !  51
                7.06130266e-02, & !  52
                6.14547729e-02, & !  53
                5.27209044e-02, & !  54
                4.44650650e-02, & !  55
                3.67408991e-02, & !  56
                2.96020508e-02, & !  57
                2.31021643e-02, & !  58
                1.72948837e-02, & !  59
                1.22338533e-02, & !  60
                7.97271729e-03, & !  61
                4.56511974e-03, & !  62
                2.06470490e-03, & !  63
                5.25116920e-04, & !  64
                4.44089210e-16  & !  65
                ]
                hybi = [          &
                0.00000000e+00, & !  1
                0.00000000e+00, & !  2
                0.00000000e+00, & !  3
                0.00000000e+00, & !  4
                0.00000000e+00, & !  5
                0.00000000e+00, & !  6
                0.00000000e+00, & !  7
                0.00000000e+00, & !  8
                0.00000000e+00, & !  9
                0.00000000e+00, & !  10
                0.00000000e+00, & !  11
                0.00000000e+00, & !  12
                0.00000000e+00, & !  13
                3.34978104e-05, & !  14
                1.19304657e-03, & !  15
                3.96668911e-03, & !  16
                8.30078125e-03, & !  17
                1.41416788e-02, & !  18
                2.14357376e-02, & !  19
                3.01293135e-02, & !  20
                4.01687622e-02, & !  21
                5.15004396e-02, & !  22
                6.40707016e-02, & !  23
                7.78259039e-02, & !  24
                9.27124023e-02, & !  25
                1.08676553e-01, & !  26
                1.25664711e-01, & !  27
                1.43623233e-01, & !  28
                1.62498474e-01, & !  29
                1.82236791e-01, & !  30
                2.02784538e-01, & !  31
                2.24088073e-01, & !  32
                2.46093750e-01, & !  33
                2.68747926e-01, & !  34
                2.91996956e-01, & !  35
                3.15787196e-01, & !  36
                3.40065002e-01, & !  37
                3.64776731e-01, & !  38
                3.89868736e-01, & !  39
                4.15287375e-01, & !  40
                4.40979004e-01, & !  41
                4.66889977e-01, & !  42
                4.92966652e-01, & !  43
                5.19155383e-01, & !  44
                5.45402527e-01, & !  45
                5.71654439e-01, & !  46
                5.97857475e-01, & !  47
                6.23957992e-01, & !  48
                6.49902344e-01, & !  49
                6.75636888e-01, & !  50
                7.01107979e-01, & !  51
                7.26261973e-01, & !  52
                7.51045227e-01, & !  53
                7.75404096e-01, & !  54
                7.99284935e-01, & !  55
                8.22634101e-01, & !  56
                8.45397949e-01, & !  57
                8.67522836e-01, & !  58
                8.88955116e-01, & !  59
                9.09641147e-01, & !  60
                9.29527283e-01, & !  61
                9.48559880e-01, & !  62
                9.66685295e-01, & !  63
                9.83849883e-01, & !  64
                1.00000000e+00  & !  65
                ]
      
          p0 = 1d5       ! Pa
          local_ptop = ptop
        case default
          call log_error("Not implemented!")
        end select

    end subroutine

    pure real(8) function da_sigma_coord_calc_ph_lev(k, phs) result(res)

    integer, intent(in) :: k
    real(8), intent(in) :: phs

    res = sigi(k) * (phs - pt) + pt

    end function da_sigma_coord_calc_ph_lev

    pure real(8) function da_hybrid_coord_calc_ph_lev(k, phs) result(res)

    integer, intent(in) :: k
    real(8), intent(in) :: phs

    res = hyai(k) * (p0 - local_ptop) + hybi(k) * (phs - local_ptop) + local_ptop

    end function da_hybrid_coord_calc_ph_lev

    subroutine da_vert_coord_final()
        deallocate(sigi)
        deallocate(hyai)
        deallocate(hybi)
    end subroutine

end module
